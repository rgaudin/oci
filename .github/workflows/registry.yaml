name: Build & Upload

on:
  push:
    branches:
      - 'main'
    tags:
      - 'base-httpd-*'
      - 'kiwix-serve-*'

jobs:
  identify:
    name: Identify which projects to build
    runs-on: ubuntu-22.04
    outputs:
      base-httpd: ${{ steps.ident.outputs.base-httpd }}
      kiwix-serve: ${{ steps.ident.outputs.kiwix-serve }}
    steps:
      # - uses: actions/checkout@v2
      - id: files
        uses: jitterbit/get-changed-files@v1
        with:
          format: 'csv'
      #- run: echo "COMMIT ${GITHUB_SHA}"
      #- run: git show --pretty="format:" --name-only ${GITHUB_SHA}
      - id: ident
        shell: python
        env:
          FILES: ${{ steps.files.outputs.all }}
        run: |
          import os
          import pathlib
          import subprocess
          import sys

          projects = set()

          print("hello", sys.version)
          print("FILES", os.getenv("FILES"))
          print("FILES2", os.getenv("FILES").split(","))

          # for tags like `base-httpd-2.0.1`
          if os.getenv("GITHUB_REF_TYPE") == "tag":
            projects.add(os.getenv("GITHUB_REF_NAME").rsplit("-", 1))

          #git = subprocess.run(["git", "show", "--pretty=format:", "--name-only", os.getenv("GITHUB_SHA", "missing")], text=True, capture_output=True)
          #print("git", git.returncode)
          #print("git", git.stdout)
          #for fname in git.stdout.splitlines():
          for fname in os.getenv("FILES").split(","):
            print("fname", fname)
            fpath = pathlib.Path(fname)
            if pathlib.Path(fpath.parts[0]).is_dir():
              projects.add(fpath.parts[0])

          for project in projects:
            print("project", project)
            print("::set-output name={project}::yes".format(project=project))

  base-httpd:
    name: Deploy base-httpd Image
    runs-on: ubuntu-22.04
    needs: identify
    if: ${{ needs.identify.outputs.base-httpd == 'yes' }}
    steps:
      - run: echo "I ran base-httpd!"

  kiwix-serve:
    name: Deploy kiwix-serve Image
    runs-on: ubuntu-22.04
    needs: identify
    if: ${{ needs.identify.outputs.kiwix-serve == 'yes' }}
    steps:
      - run: echo "I ran kiwix-serve!"
